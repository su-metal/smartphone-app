<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>THE TOLL - Workout Challenge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css?v=2.30">
  <!-- MediaPipe Pose -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFD400">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="THE TOLL">
  <link rel="apple-touch-icon" href="icons/icon-512.png">
  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('[THE TOLL] SW registered:', reg))
          .catch(err => console.error('[THE TOLL] SW registration failed:', err));
      });
    }
  </script>
  <div id="app">
    
    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="screen">
      <div class="container" style="text-align:center;">
        <span class="scs-badge" style="margin-top:20px;">SYSTEM ACCESS // 01</span>
        <h1 class="scs-hero-title">THE<br>TOLL</h1>
        <p class="scs-hero-copy">VERIFY IDENTITY TO PROCEED.</p>
        
        <div id="auth-form" class="scs-panel">
          <p id="auth-guide-1" style="font-family:'Roboto Mono'; font-size:0.8rem; margin-bottom:5px;">Initiate authentication protocol.</p>
          <p id="auth-guide-2" style="font-family:'Roboto Mono'; font-size:0.8rem; margin-bottom:20px; font-weight:bold;">SUBSCRIPTION REQUIRED.</p>
          <div class="auth-buttons">
            <button id="google-login-btn" class="scs-btn-plan" style="font-size:1.2rem;">INITIATE GOOGLE AUTH</button>
          </div>
        </div>
        
        <div id="user-info" class="hidden scs-panel">
          <p id="user-display-email" class="session-id-display" style="font-size:0.9rem; border-bottom:2px dashed black; padding-bottom:10px; margin-bottom:15px;"></p>
          
          <div id="subscription-status-badge" style="font-family:'Oswald'; font-size:1.5rem; background:black; color:white; padding:5px 10px; display:inline-block; margin-bottom:10px;"></div>
          <div id="trial-badge" class="hidden" style="font-family:'Roboto Mono'; font-size:0.8rem; background:var(--pop-yellow); padding:2px 8px; font-weight:bold; margin-bottom:15px;"></div>
          
          <button id="install-btn" class="scs-btn-plan hidden" style="margin-bottom:10px;">INSTALL APP</button>
          <button id="subscribe-btn" class="scs-btn-plan" style="margin-bottom:10px;">SUBSCRIBE ($49/YEAR)</button>
          <button id="manage-subscription-btn" class="scs-btn-plan hidden" style="margin-bottom:10px; background:#ccc; color:black;">MANAGE SUBSCRIPTION</button>
          
          <button id="to-session-btn" class="scs-btn-plan" style="background:var(--pop-yellow); color:black; border:4px solid black;">ENTER SESSION</button>
          <button id="logout-btn" class="text-btn" style="margin-top:15px; font-family:'Roboto Mono'; text-decoration:underline;">LOGOUT</button>
        </div>
        
        <a href="#" onclick="forceReset(); return false;" class="text-btn" style="display:block; margin-top: 30px; opacity: 0.5; font-family:'Roboto Mono'; font-size:0.7rem;">System Hard Reset (v2.30)</a>
      </div>
    </div>

    <!-- SESSION SCREEN -->
    <div id="session-screen" class="screen active">
      <div class="container">
        <span class="scs-badge">TARGET ACQUISITION // 02</span>
        <h1 class="scs-hero-title" style="font-size:3.5rem;">TARGET<br>LOCK</h1>
        
        <div class="scs-input-group">
          <label for="session-input" class="scs-input-label">SESSION ID</label>
          <input type="text" id="session-input" class="scs-input-field" placeholder="XXXX-XXXX" maxlength="9" autocomplete="off">
        </div>
        
        <div class="session-buttons">
          <button id="start-btn" class="scs-btn-plan" style="margin-bottom:15px; border:2px dashed var(--pop-black); background:transparent;" disabled>
            START CHALLENGE
          </button>
          
          <p id="next-exercise-display" class="subtitle hidden" style="font-size: 0.8rem; font-family:'Roboto Mono'; font-weight:bold; color: var(--pop-black); margin-bottom:10px;">EXERCISE: (LOADING...)</p>
          
          <div id="pro-exercise-selector" class="exercise-selector hidden" style="margin-bottom:20px;">
            <label for="exercise-select" class="scs-input-label" style="font-size:0.8rem;">OVERRIDE EXERCISE</label>
            <select id="exercise-select" class="scs-input-field" style="padding:5px; font-size:1rem;">
              <option value="0">SQUAT</option>
              <option value="1">PUSH-UP</option>
              <option value="2">SIT-UP</option>
            </select>
          </div>
          
          <div style="font-size: 0.7rem; font-family:'Roboto Mono'; opacity: 0.6; margin-bottom: 20px; text-align:center;">
             <a href="#" id="reset-cycle-btn" style="color: black; text-decoration: none;">[FORCE NEXT]</a>
             <span id="cycle-debug-info" style="margin-left: 10px;">ID: -</span>
          </div>
          
          <button id="scan-qr-btn" class="scs-btn-plan scs-btn-black">
            SCAN QR CODE
          </button>
        </div>
        
        <p class="subtitle" id="session-help-text" style="margin-top: 20px; font-family:'Roboto Mono'; font-size:0.8rem; text-align:center;">Enter the ID shown on your PC</p>
        
        <a href="#" id="session-logout-btn" class="text-btn hidden" style="display:block; text-align:center; margin-top:20px; font-family:'Roboto Mono';">Logout from this account</a>
        <a href="#" onclick="forceReset(); return false;" class="text-btn" style="display:block; margin-top:10px; opacity: 0.5; text-align:center; font-family:'Roboto Mono'; font-size:0.7rem;">System Hard Reset (v2.30)</a>
      </div>

      <!-- QR Scanner Overlay -->
      <div id="qr-reader-container" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:999; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div id="qr-reader" style="width:100%;"></div>
        <button id="close-scan-btn" class="scs-btn-plan" style="width:auto; margin-top:20px; background:white; color:black;">CANCEL SCAN</button>
      </div>
    </div>

    <!-- SQUAT SCREEN (HUD) -->
    <div id="squat-screen" class="screen">
      <div class="camera-container" style="position:relative; width:100%; height:100vh; overflow:hidden; background:black;">
        <video id="camera" autoplay muted playsinline style="width:100%; height:100%; object-fit:cover;"></video>
        <canvas id="pose-canvas" style="position:absolute; top:0; left:0; width:100%; height:100%;"></canvas>
        
        <!-- Brutalist HUD Overlay -->
        <div class="overlay-ui scs-hud-overlay">
          <div class="scs-hud-top">
            <div class="scs-hud-val" style="font-size:1.2rem;">SESSION: <span id="current-session">-</span></div>
            <div class="hud-top-right" style="display:flex; align-items:center; gap:10px;">
              <button id="fullscreen-btn" style="background:none; border:none; color:white; font-family:'Oswald'; font-size:1rem;">[FULL]</button>
              <div class="hud-status scs-hud-val" id="status" style="background:var(--pop-black); padding:2px 5px;">READY</div>
            </div>
          </div>

          <div class="scs-hud-center">
             <div class="exercise-name" id="exercise-label" style="font-family:'Oswald'; font-size:2rem; color:white; text-shadow:2px 2px 0 black; margin-bottom:-10px;">EXERCISE</div>
             <div class="squat-counter">
               <span id="squat-count" class="scs-hud-huge-count">0</span>
               <span class="squat-total" style="font-family:'Oswald'; font-size:2rem; color:#ccc;">/<span id="target-count-display">20</span></span>
             </div>
          </div>
          
          <div class="hud-bottom">
            <div class="hud-bottom-flex" style="background:rgba(0,0,0,0.7); padding:10px; border:2px solid white;">
              <div class="squat-guide" id="squat-hint" style="font-family:'Oswald'; font-size:1.5rem; color:var(--pop-yellow); text-align:center;">LOWER YOUR BODY</div>
              <div style="display: flex; gap: 10px; margin-top:10px; justify-content:center;">
                <button id="recalibrate-btn" style="background:transparent; border:1px solid #999; color:#ccc; font-family:'Roboto Mono'; font-size:0.7rem; padding:5px;">RESET CAPTURE</button>
                <button id="exit-btn" style="background:var(--pop-pink); border:none; color:white; font-family:'Oswald'; padding:5px 15px; font-size:1rem;">EXIT</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="guide-overlay" id="guide" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; text-align:center; z-index:100;">
          <div class="squat-guide" style="font-family:'Oswald'; font-size:3rem; color:var(--pop-yellow); border:4px solid var(--pop-yellow); padding:20px;">
            STAND BACK<br>SHOW US YOUR BODY!
          </div>
        </div>
      </div>
    </div>

    <!-- COMPLETE SCREEN -->
    <div id="complete-screen" class="screen">
      <div class="container complete-container" style="text-align:center; display:flex; flex-direction:column; justify-content:center; min-height:100vh;">
        <div class="complete-ring" style="width:120px; height:120px; border:8px solid var(--pop-black); border-radius:50%; display:flex; justify-content:center; align-items:center; margin:0 auto 30px; box-shadow:8px 8px 0px var(--pop-yellow);">
          <div class="check-mark" style="font-size:4rem; color:var(--pop-black);">✓</div>
        </div>
        
        <h1 class="complete-title scs-hero-title" style="font-size:4rem; margin-bottom:10px;">ACCESS<br>GRANTED</h1>
        <p class="complete-subtitle scs-hero-copy" style="font-size:1rem; margin-bottom:30px;">PROCEED TO WORKSTATION.</p>
        
        <div class="stats-grid scs-spec-section dark" style="padding:20px; margin-bottom:30px; border:4px solid var(--pop-black); background:black; color:white;">
          <div class="stat-box" style="margin-bottom:15px; border-bottom:1px dashed #555; padding-bottom:10px;">
            <div class="val" id="complete-reps-display" style="font-family:'Oswald'; font-size:3rem; color:var(--pop-yellow);">20</div>
            <div class="lbl" style="font-family:'Roboto Mono'; font-size:0.8rem; color:#999;">REPS COMPLETE</div>
          </div>
          <div class="stat-box">
            <div class="val" id="session-time" style="font-family:'Oswald'; font-size:3rem; color:white;">--</div>
            <div class="lbl" style="font-family:'Roboto Mono'; font-size:0.8rem; color:#999;">SECONDS ELAPSED</div>
          </div>
        </div>
        
        <button id="unlock-btn" class="scs-btn-plan" style="margin-bottom:20px;">
          UNLOCK PC
        </button>
        
        <p class="subtitle" id="unlock-status" style="margin-top: 10px; font-family:'Roboto Mono'; font-weight:bold;"></p>
        
        <a href="#" id="back-to-session-btn" class="text-btn" style="display:block; margin-bottom: 20px; font-family:'Roboto Mono'; font-weight:bold; color:black; text-decoration:underline;">START ANOTHER SESSION</a>
        
        <a href="#" onclick="forceReset(); return false;" class="text-btn" style="opacity: 0.5; font-family:'Roboto Mono'; font-size:0.7rem;">System Hard Reset (v2.30)</a>
      </div>
    </div>
        
    <!-- Debug Console -->
    <div id="debug-console"></div>
  </div>

  <script src="app.js?v=2.33"></script>
  <script>
    const appLang = new URLSearchParams(window.location.search).get('lang') === 'ja' ? 'ja' : 'en';
    if (appLang === 'ja') {
      document.documentElement.lang = 'ja';
      document.title = 'THE TOLL - スクワットチャレンジ';
      const sessionHelp = document.getElementById('session-help-text');
      if (sessionHelp) sessionHelp.textContent = 'PCに表示されたIDを入れてね';
      const authGuide1 = document.getElementById('auth-guide-1');
      const authGuide2 = document.getElementById('auth-guide-2');
      const googleLoginBtn = document.getElementById('google-login-btn');
      const manageSubscriptionBtn = document.getElementById('manage-subscription-btn');
      if (authGuide1) authGuide1.textContent = 'Googleアカウントで登録・ログインします。';
      if (authGuide2) authGuide2.textContent = 'セッション開始には有料プランが必要です。';
      if (googleLoginBtn) googleLoginBtn.textContent = 'Googleで続行';
      if (manageSubscriptionBtn) manageSubscriptionBtn.textContent = 'サブスク管理';
    }

    // 強制リセット関数
    async function forceReset() {
      if(!confirm(appLang === 'ja' ? 'アプリを初期化して再読み込みしますか？' : 'Reset app data and reload?')) return;
      
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (let registration of registrations) {
          await registration.unregister();
        }
      }
      
      if ('caches' in window) {
        const keys = await caches.keys();
        await Promise.all(keys.map(key => caches.delete(key)));
      }
      
      localStorage.clear();
      window.location.reload(true);
    }
  </script>
</body>
</html>
